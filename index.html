<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans+Narrow:700&display=swap" rel="stylesheet">
  <style>
    body { background: #f7efe0;font-family: 'PT Sans Narrow', Arial, sans-serif; margin:0; min-height:100vh; color:#2b2b2b;}
    .header { text-align:center; padding:28px 12px 10px 12px; background:#556B2F; color:#fff;}
    .header-title { font-size:2.0em; color:#fff; font-weight:800;}
    .header-desc { color:#fffbe6; margin-top:6px;}
    .menu { max-width:800px; margin:32px auto 0; display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
    .product {background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,0.08);padding:16px;text-align:center;}
    .product-img {max-width:90px;border-radius:10px;margin-bottom:8px;}
    .controls {margin:10px 0;display:flex;align-items:center;justify-content:center;gap:8px;}
    .add-btn,.remove-btn{border:none;border-radius:8px;font-size:1em;padding:6px 12px;cursor:pointer;transition:filter .12s;}
    .add-btn{background:#556B2F;color:#fff;}
    .remove-btn{background:#fff;color:#556B2F;border:1px solid #6b7a29;}
    .cart-fab {position:fixed;bottom:22px;right:18px;background:#b3611f;color:#fff;border-radius:50%;width:62px;height:62px;font-size:2em;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:999;}
    .cart-fab-count{background:#fff;color:#b3611f;border-radius:50%;width:26px;height:26px;position:absolute;right:6px;top:7px;text-align:center;font-size:1em;line-height:26px;}
    .cart-modal-bg{position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1100;display:none;align-items:flex-start;justify-content:center;}
    .cart-modal{background:#f7efe0;border-radius:18px;padding:24px 14px 14px 14px;min-width:320px;max-width:92vw;box-shadow:0 12px 36px rgba(0,0,0,0.10);}
    .cart-title{font-size:1.22em;margin-bottom:14px;}
    .cart-list{list-style:none;padding:0;}
    .cart-list li{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .cart-total{font-size:1.01em;text-align:right;margin:12px 0;}
    .cart-close{position:absolute;right:12px;top:8px;font-size:1.3em;background:none;border:none;cursor:pointer;}
    .order-form input, .order-form select, .order-form textarea {width:100%;padding:8px;margin-bottom:8px;border-radius:7px;border:1px solid #ccc;font-size:1em;}
    .order-btn{background:#b3611f;color:#fff;padding:10px 18px;border:none;border-radius:8px;font-weight:800;width:100%;margin-top:8px;}
    .order-success{color:#2e7d32;font-size:1.05em;text-align:center;margin-top:10px;}
    .tg-info{font-size:.93em;color:#8a7700;background:#fffebc;padding:8px 14px;border-radius:6px;margin:17px 0;}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">–°–í–û–Ø –ö–£–•–ù–Ø</div>
    <div class="header-desc">–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã ‚Äî –≤–∫—É—Å–Ω–æ, –±—ã—Å—Ç—Ä–æ, —Ä—è–¥–æ–º</div>
  </div>

  <div class="tg-info">
    <b>–®–∞–≥ 1:</b> –ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç" –Ω–∞—à–µ–º—É –±–æ—Ç—É –≤ Telegram: <a href="https://t.me/–í–ê–®_BOT_USERNAME" target="_blank">@–í–ê–®_BOT_USERNAME</a>.<br>
    <b>–®–∞–≥ 2:</b> –í–ø–∏—à–∏—Ç–µ —Å–≤–æ–π Telegram username (–±–µ–∑ @) –≤ —Ñ–æ—Ä–º—É –∑–∞–∫–∞–∑–∞.<br>
    <i>–¢–æ–≥–¥–∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –≤–∞—à –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—ë–Ω.</i>
  </div>

  <div class="menu" id="menu"></div>

  <div class="cart-fab" id="cartFab" style="display:none;" title="–ö–æ—Ä–∑–∏–Ω–∞">
    üõí
    <span id="cartFabCount" class="cart-fab-count"></span>
  </div>

  <div id="cartModalBg" class="cart-modal-bg"></div>

  <script>
    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
    // –ù–∞—Å—Ç—Ä–æ–π —Å—é–¥–∞ –ø–æ–¥ —Å–µ–±—è:
    const TELEGRAM_BOT_TOKEN = '7637734194:AAGLXLycqKlHpi4183_4Jaaaz3bwm_SJXqw';
    const TELEGRAM_OPERATOR_CHAT_ID = '7567253745'; // id –≥—Ä—É–ø–ø—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–ª–∏ –ª–∏—á–Ω—ã–π id –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

    // –ü—Ä–∏–º–µ—Ä API Google –¢–∞–±–ª–∏—Ü (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π ID –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π endpoint!)
    const SHEET_API_FALLBACK = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';

    let menuData = [];
    let cart = {};

    const RUB_FMT = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 });

    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    async function loadMenu() {
      try {
        const res = await fetch(SHEET_API_FALLBACK);
        const j2 = await res.json();
        if (j2 && j2.menu && Array.isArray(j2.menu)) {
          menuData = j2.menu.map((item, idx) => ({
            id: idx + 1,
            name: item.name || `–ë–ª—é–¥–æ ${idx+1}`,
            description: item.description || '',
            img: item.img || '',
            price: Number(item.price) || 0,
            available: String(item.available).trim().toLowerCase() === 'true'
          }));
          renderMenu();
          return;
        }
        document.getElementById('menu').innerHTML = '<div>–ú–µ–Ω—é –ø—É—Å—Ç–æ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
      } catch (e) {
        document.getElementById('menu').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é.</div>';
      }
    }

    function renderMenu() {
      const menu = document.getElementById('menu');
      menu.innerHTML = '';
      if (!menuData || menuData.length === 0) {
        menu.innerHTML = '<div style="color:#556B2F;font-size:1.1em;text-align:center;margin:40px auto;">–ú–µ–Ω—é –ø—É—Å—Ç–æ.</div>';
        updateCartFab();
        return;
      }
      menuData.forEach(item => {
        const prod = document.createElement('div');
        prod.className = 'product' + (!item.available ? ' unavailable' : '');
        const priceText = RUB_FMT.format(Number(item.price) || 0);
        prod.innerHTML = `
          <img class="product-img" src="${item.img || 'https://via.placeholder.com/100x100?text=–§–æ—Ç–æ'}" alt="${escapeHtml(item.name)}">
          <div class="product-name">${escapeHtml(item.name)}</div>
          <div class="product-desc">${escapeHtml(item.description || '')}</div>
          <div class="product-price">${priceText}</div>
          <div class="controls">
            <button class="remove-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},-1)">‚àí</button>
            <span id="qty-${item.id}">${cart[item.id]?.qty||0}</span>
            <button class="add-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},1)">+</button>
          </div>
        `;
        menu.appendChild(prod);
      });
      updateCartFab();
    }

    window.updateCart = function(id, delta) {
      const item = menuData.find(i=>i.id===id);
      if (!item || !item.available) return;
      if (!cart[id]) cart[id] = { ...item, qty: 0 };
      cart[id].qty = Math.max(0, cart[id].qty + delta);
      if (cart[id].qty === 0) delete cart[id];
      const qtyEl = document.getElementById(`qty-${id}`);
      if (qtyEl) qtyEl.textContent = cart[id]?.qty || 0;
      updateCartFab();
      if (document.getElementById('cartModalBg').style.display === 'flex') showCartModal();
    };

    function updateCartFab() {
      const fab = document.getElementById('cartFab');
      const count = Object.values(cart).reduce((s,i)=>s + (i.qty || 0), 0);
      if (count > 0) {
        fab.style.display = 'flex';
        document.getElementById('cartFabCount').textContent = count;
      } else {
        fab.style.display = 'none';
        document.getElementById('cartFabCount').textContent = '';
      }
    }

    document.getElementById('cartFab').onclick = showCartModal;

    function showCartModal() {
      const modalBg = document.getElementById('cartModalBg');
      const items = Object.values(cart).sort((a, b) => a.id - b.id);
      const listHtml = items.length === 0
        ? '<li style="color:#556B2F;text-align:center;width:100%;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</li>'
        : items.map(it => `
            <li>
              <span>${escapeHtml(it.name)} x${it.qty}</span>
              <span>
                <button class="remove-btn" onclick="updateCart(${it.id},-1)">‚àí</button>
                <span style="margin:0 8px;">${RUB_FMT.format((it.price||0) * it.qty)}</span>
                <button class="add-btn" onclick="updateCart(${it.id},1)">+</button>
              </span>
            </li>
          `).join('');
      const total = items.reduce((s,i)=>s + (i.price || 0) * i.qty, 0);
      modalBg.innerHTML = `
        <div class="cart-modal" role="dialog" aria-modal="true" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
          <button class="cart-close" onclick="closeCartModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
          <div class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
          <ul class="cart-list">${listHtml}</ul>
          <div class="cart-total">–ò—Ç–æ–≥–æ: ${RUB_FMT.format(total)}</div>
          <form class="order-form" id="orderForm">
            <input type="text" id="name" placeholder="–í–∞—à Telegram username (–±–µ–∑ @)" required>
            <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
            <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required>
            <select id="payment">
              <option value="">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
              <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
              <option value="qr">QR (–æ–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∫–∞–Ω)</option>
            </select>
            <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            <button type="submit" class="order-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div id="orderSuccess" class="order-success" style="display:none;"></div>
          </form>
        </div>
      `;
      modalBg.style.display = 'flex';
      const orderForm = document.getElementById('orderForm');
      if (orderForm) orderForm.onsubmit = sendOrder;
      setTimeout(() => {
        const modal = document.querySelector('.cart-modal');
        if (modal) modal.scrollIntoView({behavior: "smooth", block: "start"});
      }, 50);
    }

    window.closeCartModal = function() {
      document.getElementById('cartModalBg').style.display = 'none';
    };

    async function sendOrder(e) {
      e.preventDefault();
      const btn = document.querySelector('.order-btn');
      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      const name = document.getElementById('name').value.trim(); // username –±–µ–∑ @ !
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const payment = document.getElementById('payment').value;
      const comment = document.getElementById('comment').value.trim();

      if (!name || !phone || !address) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return;
      }
      const itemsArr = Object.values(cart);
      if (itemsArr.length === 0) { alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return; }
      const total = itemsArr.reduce((s,i)=>s + (i.price||0)*i.qty,0);
      let orderLines = itemsArr.map(i=>`${i.name} x${i.qty} ‚Äî ${RUB_FMT.format(i.price * i.qty)}`).join('\n');
      let paymentText = payment==='cash' ? '–û–ø–ª–∞—Ç–∞: –ù–∞–ª–∏—á–Ω—ã–µ' : payment==='qr' ? '–û–ø–ª–∞—Ç–∞: QR' : '';
      const orderId = 'order_' + Math.random().toString(36).substr(2,9);
      const text =
        `üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ (–°–í–û–Ø –ö–£–•–ù–Ø)\n` +
        `Telegram username: @${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n` +
        (paymentText?paymentText+'\n':'') +
        (comment?`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}\n`:'') +
        `\n–ó–∞–∫–∞–∑:\n${orderLines}\n\n–°—É–º–º–∞: ${RUB_FMT.format(total)}`;

      // inline-–∫–Ω–æ–ø–∫–∏, –≥–¥–µ –≤ data username!
      const msg = {
        chat_id: TELEGRAM_OPERATOR_CHAT_ID,
        text,
        reply_markup: JSON.stringify({
          inline_keyboard: [
            [
              {text: "‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data: `accept_${name}_${orderId}`},
              {text: "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data: `decline_${name}_${orderId}`}
            ]
          ]
        })
      };

      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(msg)
        });
        const result = await response.json();
        if (result.ok) {
          btn.style.display = 'none';
          document.getElementById('orderSuccess').style.display = 'block';
          document.getElementById('orderSuccess').textContent = '–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.';
          cart = {};
          setTimeout(()=>{ closeCartModal(); renderMenu(); }, 1500);
        } else {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
          btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadMenu();
  </script>
</body>
</html>
